#cloud-config

# Upgrade on first boot
package_update: true
package_upgrade: true

# Add baseline packages
packages:
  - git
  - ufw

write_files:
  # Setup the reconciliation data (systemd)
  - path: /etc/systemd/system/reconcile.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Run reconciliation script

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/reconcile.sh

  - path: /etc/systemd/system/reconcile.timer
    permissions: '0644'
    content: |
      [Unit]
      Description=Timer for reconciliation script

      [Timer]
      OnBootSec=${boot_delay}
      OnUnitActiveSec=${reconciliation_intervall}
      Persistent=true

      [Install]
      WantedBy=timers.target

  - path: /usr/local/bin/reconcile.sh
    permissions: '0755'
    content: |
      ${indented_reconciliation_script}

  # TODO! Disable SSH once we have verified the module works
  - path: /etc/ssh/sshd_config.d/99-temporary-dev.conf
    permissions: '0644'
    content: |
      PermitRootLogin prohibit-password
      PasswordAuthentication no
      ChallengeResponseAuthentication no
      PubkeyAuthentication yes
      AllowAgentForwarding no
      AllowTcpForwarding no
      X11Forwarding no

runcmd:
  # Limit to only standard web ports
  - ufw allow 22/tcp # TODO! Remove once we know the module is working
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw --force enable

  # Add Docker's official GPG Signing key
  - install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  - chmod a+r /etc/apt/keyrings/docker.gpg

  # Add Docker's official repository
  - |
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
      https://download.docker.com/linux/debian \
      $(lsb_release -cs) stable" \
      > /etc/apt/sources.list.d/docker.list

  # Update package index and install Docker components
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

  # Ensure docker is running
  - systemctl enable docker
  - systemctl start docker

  # Create GitOps repo dir
  - mkdir -p /srv/gitops

  # Setup the reconciliation service
  - chmod +x /usr/local/bin/reconcile.sh
  - systemctl daemon-reload
  - systemctl enable reconcile.timer
  - systemctl start reconcile.timer
